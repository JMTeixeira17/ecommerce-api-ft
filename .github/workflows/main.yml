# .github/workflows/main.yml

name: CI/CD a Google Cloud Run (Java 21)

on:
  push:
    branches:
      - main # Dispara el workflow en cada push a la rama principal

env:
  # --- Configuración de GCP ---
  GCP_PROJECT_ID: cool-benefit-439020-e8 # El ID de proyecto que proporcionaste
  GCP_REGION: us-central1 # La región donde se desplegará
  SERVICE_NAME: ecommerce-api # Nombre del servicio en Cloud Run
  # --- Configuración de la App ---
  ARTIFACT_NAME: ecommerce-api-1.0.0-SNAPSHOT.jar
  IMAGE_NAME: gcr.io/cool-benefit-439020-e8/ecommerce-api:latest

jobs:
  # =======================================================================
  # 1. CD: COMPILAR, CREAR IMAGEN Y DESPLEGAR (Job Único)
  # =======================================================================
  ci-tests:
    name: Build & Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build with Maven and Run Tests
        # Ejecuta mvn clean install (incluye la verificación de Jacoco 80%)
        run: mvn clean install

      - name: Save JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: java-app-jar
          path: target/${{ env.ARTIFACT_NAME }}
  deploy-to-gcp:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    # Este job es el único, así que no necesita 'needs:'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. Autenticación con Google Cloud ---
      - name: Authorize GCP Service Account
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }} # Usa el secreto de GitHub

      # --- 2. Set up Java 21 (Necesario para que Docker compile Maven) ---
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      # --- 3. Configurar Docker para usar Google Container Registry (GCR) ---
      - name: Configure Docker Login to GCR
        uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      # --- 4. Construir Imagen de Docker y Subir a GCR ---
      - name: Build and Push Docker Image
        id: build-image
        run: |
          # Construye la imagen (Maven compila el JAR dentro de la etapa 'builder' del Dockerfile)
          docker build -t ${{ env.IMAGE_NAME }} .
          # Sube la imagen final al registro de GCP
          docker push ${{ env.IMAGE_NAME }}

      # --- 5. Desplegar en Cloud Run (Inyección de Secretos) ---
      - name: Deploy to Google Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.IMAGE_NAME }}
          flags: --cpu=1 --memory=512Mi --min-instances=0

          # CRÍTICO: Inyectar todas las variables que application-prod.yml espera.
          env_vars: |
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            API_SECRET_KEY=${{ secrets.API_SECRET_KEY }}
            AES_KEY=${{ secrets.AES_KEY }}
            AES_IV=${{ secrets.AES_IV }}
            MAIL_HOST=${{ secrets.MAIL_HOST }}
            MAIL_PORT=${{ secrets.MAIL_PORT }}
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            API_BASE_URL=https://ecommerce-api-468133790239.us-central1.run.app/api/v1